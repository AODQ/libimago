#!/bin/sh

prefix=/usr/local
use_libpng=true
use_libjpeg=true

gen_module_init()
{
	# collect all src/file_whatever.c files
	modules=`ls src/file_*.c 2>/dev/null | sort | sed 's/src\/file_//' | sed 's/\.c//'`

	echo "/* this file is generated by $0, do not edit */"
	for m in $modules; do
		echo "int img_register_$m();"
	done

	echo
	echo 'void img_modules_init(void)'
	echo '{'

	for m in $modules; do
		echo "	img_register_$m();"
	done

	echo '}'
}

for arg in "$@"; do
	case "$arg" in
	--prefix=*)
		prefix=`echo $arg | sed 's/--prefix=//'`
		;;

	--disable-png)
		defs="-DNO_PNG $defs"
		use_libpng=false
		;;

	--disable-jpeg)
		defs="-DNO_JPEG $defs"
		use_libjpeg=false
		;;

	--help)
		echo 'usage: ./configure [options]'
		echo 'options:'
		echo '  --prefix=<path>: installation path (default: /usr/local)'
		echo '  --disable-png: build without PNG support'
		echo '  --disable-jpeg: build without JPEG support'
		echo 'all invalid options are silently ignored'
		exit 0
		;;
	esac
done

gen_module_init >src/modules.c

echo "PREFIX = $prefix" >Makefile
echo "defs = $defs" >>Makefile
if $use_libpng; then
	echo "ldflags_png = -lpng -lz" >>Makefile
fi
if $use_libjpeg; then
	echo "ldflags_jpeg = -ljpeg" >>Makefile
fi
cat Makefile.in >>Makefile

echo 'configuration completed, type make (or gmake) to build.'
